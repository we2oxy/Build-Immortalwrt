name:  R2S-1806-K5.4

on:
  repository_dispatch:
  workflow_dispatch:
  # schedule:
    # - cron:  '40 16 * * 0,3'

jobs:
  R2S-1806-K54:
    runs-on: ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      
    - name: Cleanup Workflow Runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 7
        keep_minimum_runs: 5

    - name: Init Building Dependencies
      env:
        DEBIAN_FRONTEND: noninteractive 
      run: |
        sudo chmod -R +x $GITHUB_WORKSPACE/scripts/*.sh $GITHUB_WORKSPACE/scripts/source_code/*.sh
        ls -alhR $GITHUB_WORKSPACE/scripts/*
        #bash $GITHUB_WORKSPACE/scripts/01_init_env.sh
        sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
        sudo lsb_release -a
        sudo cat /etc/os-release
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install squashfs-tools $(curl -fsSL git.io/depends-ubuntu-2004)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        docker image prune -a -f
        sudo -E swapoff -a
        ulimit -n 4096
        df -hP

    - name: Clone Source
      run: |
        sudo mkdir -pv /build/{package,upload,buildinfo}
        sudo chown -R runner:runner /build
        git clone --branch openwrt-18.06-k5.4 --single-branch --depth 1 https://github.com/immortalwrt/immortalwrt.git /build/immortalwrt
        cd /build/immortalwrt
        rm -rf tmp/
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        cat $GITHUB_WORKSPACE/buildinfo/R2S/R2S-1806-K5.4.buildinfo > /build/immortalwrt/.config
        # sed -i '/CONFIG_PACKAGE_findutils/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_findutils-find/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_findutils-locate/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_findutils-xargs/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_logrotate/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_lsattr/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_lsblk/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_lscpu/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_lsof/d' /build/immortalwrt/.config
        #sed -i '/CONFIG_PACKAGE_tcpdump/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_tar/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_chattr/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_gawk/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_hwinfo/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_jq/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_less/d' /build/immortalwrt/.config
        sed -i '/CONFIG_PACKAGE_lftp/d' /build/immortalwrt/.config
        echo "##################.config#################"
        rm -rf /build/immortalwrt/feeds/luci/applications/luci-app-ssr-plus
        rm -rf /build/immortalwrt/feeds/luci/applications/luci-app-smartdns
        rm -rf /build/immortalwrt/feeds/packages/net/smartdns/Makefile       
        # del net package
        for i in {chinadns-ng,dns2socks,dns2tcp,hysteria,ipt2socks,microsocks,naiveproxy,redsocks2,sagernet-core,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan,v2ray-core,v2ray-geodata,v2ray-plugin,v2raya,xray-core,xray-plugin} ;do echo ${i} ;done
        for i in {chinadns-ng,dns2socks,dns2tcp,hysteria,ipt2socks,microsocks,naiveproxy,redsocks2,sagernet-core,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan,v2ray-core,v2ray-geodata,v2ray-plugin,v2raya,xray-core,xray-plugin} ;do rm -vrf /build/immortalwrt/feeds/packages/net/${i} ;done
        # add net package
        for i in {chinadns-ng,dns2socks,dns2tcp,hysteria,ipt2socks,lua-neturl,microsocks,naiveproxy,redsocks2,sagernet-core,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan,v2ray-core,v2ray-geodata,v2ray-plugin,v2raya,xray-core,xray-plugin} ;do echo "# svn export /build/immortalwrt/feeds/packages/net/${i}" && svn export https://github.com/fw876/helloworld/trunk/${i} /build/immortalwrt/feeds/packages/net/${i} ;done
        for i in {chinadns-ng,dns2socks,dns2tcp,hysteria,ipt2socks,lua-neturl,microsocks,naiveproxy,redsocks2,sagernet-core,shadowsocks-rust,shadowsocksr-libev,simple-obfs,tcping,trojan,v2ray-core,v2ray-geodata,v2ray-plugin,v2raya,xray-core,xray-plugin} ;do echo "# /build/immortalwrt/feeds/packages/net/${i}" && ls -lh /build/immortalwrt/feeds/packages/net/${i} ;done
        # luci-app-smartdns
        svn export https://github.com/pymumu/luci-app-smartdns/branches/lede /build/immortalwrt/feeds/luci/applications/luci-app-smartdns
        svn export https://github.com/immortalwrt/packages/branches/openwrt-18.06/net/smartdns/Makefile /build/immortalwrt/feeds/packages/net/smartdns/Makefile
        # luci-app-ssr-plus
        svn export https://github.com/fw876/helloworld/trunk/luci-app-ssr-plus /build/immortalwrt/feeds/luci/applications/luci-app-ssr-plus
        cat -n /build/immortalwrt/.config

    - name: Configuration Customization
      id: configuration
      run: |
        mkdir -pv /build/immortalwrt/files/etc/crontabs/
        mkdir -pv /build/immortalwrt/files/etc/config/
        mkdir -pv /build/immortalwrt/files/etc/ssrplus/
        echo "0 */1 * * * /usr/sbin/ntpdate ntp.tencent.com && /usr/sbin/hwclock -w" >/build/immortalwrt/files/etc/crontabs/root
        wget -P /build/immortalwrt/files/etc/config/ https://raw.githubusercontent.com/we2oxy/mynotebook/master/openwrt/files/etc/config/ttyd
        curl -s "https://raw.hellogithub.com/hosts" | sed -e '/#/d' -e '/^$/d' | awk '{print $2}' >/build/immortalwrt/files/etc/ssrplus/black.list
        cat /build/immortalwrt/files/etc/ssrplus/black.list
        sed -i 's#-SNAPSHOT##g' /build/immortalwrt/include/version.mk
        sed -i 's#-SNAPSHOT##g' /build/immortalwrt/package/base-files/image-config.in
        sed -i 's#192.168.1.1#192.168.100.51#' /build/immortalwrt/package/base-files/files/bin/config_generate
        sed -i 's#255.255.255.0#255.255.0.0#' /build/immortalwrt/package/base-files/files/bin/config_generate
        sed -i "/Load Average/i\\\t\t<tr><td width="33%"><%:Build Date %></td><td>`date +%F_%T`</td></tr>" /build/immortalwrt/package/emortal/autocore/files/generic/index.htm
        grep "Build Date" /build/immortalwrt/package/emortal/autocore/files/generic/index.htm
        # uci 99-default-settings
        cat -n $GITHUB_WORKSPACE/uciconf/R2S/*.txt 
        sed -i '/exit 0/d' /build/immortalwrt/package/emortal/default-settings/files/99-default-settings
        sed -i '/CYXluq4wUazHjmCDBCqXF/d' /build/immortalwrt/package/emortal/default-settings/files/99-default-settings
        cat $GITHUB_WORKSPACE/uciconf/R2S/1806_sys_uci_custom.txt >> /build/immortalwrt/package/emortal/default-settings/files/99-default-settings
        cat -n /build/immortalwrt/package/emortal/default-settings/files/99-default-settings
        rm -rf /build/immortalwrt/feeds/luci/applications/luci-app-ssr-plus/po/zh_Hans
        cd /build/immortalwrt/feeds/luci/applications/luci-app-ssr-plus
        sed -n '/result.encrypt_method/a\                result.fast_open = "1"' root/usr/share/shadowsocksr/subscribe.lua
        sed -i '/result.encrypt_method/a\                result.fast_open = "1"' root/usr/share/shadowsocksr/subscribe.lua
        cd /build/immortalwrt/
        ./scripts/feeds install -a
        # uci 50_luci-smartdns
        sed -i '/exit 0/d' /build/immortalwrt/feeds/luci/applications/luci-app-smartdns/root/etc/uci-defaults/50_luci-smartdns
        cat $GITHUB_WORKSPACE/uciconf/R2S/my_smartdns_uci_custom.txt >> /build/immortalwrt/feeds/luci/applications/luci-app-smartdns/root/etc/uci-defaults/50_luci-smartdns
        cat -n /build/immortalwrt/feeds/luci/applications/luci-app-smartdns/root/etc/uci-defaults/50_luci-smartdns
        # uci luci-ssr-plus
        sed -i '/exit 0/d' /build/immortalwrt/feeds/luci/applications/luci-app-ssr-plus/root/etc/uci-defaults/luci-ssr-plus
        cat $GITHUB_WORKSPACE/uciconf/R2S/my_ssr_uci_custom.txt >> /build/immortalwrt/feeds/luci/applications/luci-app-ssr-plus/root/etc/uci-defaults/luci-ssr-plus
        cat -n /build/immortalwrt/feeds/luci/applications/luci-app-ssr-plus/root/etc/uci-defaults/luci-ssr-plus

    - name: Defconfig
      id: defconfig
      run: |
        bash $GITHUB_WORKSPACE/scripts/03_defconfig.sh R2S-1806-K5.4.buildinfo
        
    - name: Deliver buildinfo
      if: ${{ always() }}
      uses: actions/upload-artifact@v3
      with:
        name: OpenWrt_buildinfo_R2S-K5.4
        path: /build/buildinfo/
        if-no-files-found: ignore
        
    - name: Compile
      id: tools
      run: |
        cd /build/immortalwrt/
        echo -e "$(nproc) thread compile"
        make -j$(($(nproc) + 1)) || make -j1 V=s
        tree bin/
        tree -d bin/
        cd /build/immortalwrt/bin/targets/rockchip/armv8 && ls -lSha
        
    - name: Prepare artifact
      run: |
        bash $GITHUB_WORKSPACE/scripts/04_packaging.sh
        
    - name: Deliver firmware
      if: ${{ always() }}
      uses: actions/upload-artifact@v3
      with:
        name: Immortalwrt_firmware_R2S-K5.4
        path: /build/upload/
        if-no-files-found: ignore
        
    - name: Generate release tag
      id: tag
      run: |
        touch release.txt
        echo "http://192.168.100.51" > release.txt
        echo "http://immortalwrt.lan" >> release.txt
        echo "netmask 255.255.0.0" >> release.txt
        echo "tag_name=Immortalwrt_Nanopi-r2s" >> $GITHUB_ENV
        echo "build_date=`date +%F_%H%M%S`" >> $GITHUB_ENV
        
    - name: Upload firmware to release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: ${{ env.tag_name }}_${{ env.build_date }}
        tag_name: ${{ env.tag_name }}_${{ env.build_date }}
        body_path: release.txt
        files: |
          /build/upload/*
